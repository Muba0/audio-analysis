<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Processing</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .status-item {
            opacity: 0.5;
            transition: opacity 0.3s ease;
        }
        .status-item.active {
            opacity: 1;
            font-weight: bold;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
    <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-md">
        <h1 class="text-2xl font-bold mb-6 text-center text-gray-800">Audio Processing</h1>
        
        <div class="mb-4">
            <p class="text-sm text-gray-600">Audio Length: <span id="audioLength">{{ audio_length }} minutes ({{ audio_length_seconds }} seconds)</span></p>
            <p class="text-sm text-gray-600">Estimated Processing Time: <span id="estimatedTime">{{ estimated_time }} seconds</span></p>
        </div>

        <div id="statusContainer" class="space-y-2 mb-6">
            <div id="uploadStatus" class="status-item p-2 bg-gray-100 rounded">
                ‚è≥ Preparing to upload audio file
            </div>
            <div id="analysisStatus" class="status-item p-2 bg-gray-100 rounded">
                üîç Initializing analysis
            </div>
            <div id="processingStatus" class="status-item p-2 bg-gray-100 rounded">
                üìä Processing audio content
            </div>
            <div id="completedStatus" class="status-item p-2 bg-gray-100 rounded">
                ‚úÖ Generating final report
            </div>
        </div>

        <div id="progressBar" class="w-full bg-gray-200 rounded-full h-2.5 mb-4">
            <div id="progressBarInner" class="bg-indigo-600 h-2.5 rounded-full" style="width: 0%"></div>
        </div>

        <button id="viewResultsBtn" disabled class="w-full bg-gray-300 text-white py-2 px-4 rounded-md cursor-not-allowed">
            Waiting for Analysis...
        </button>

        <form id="processForm" action="/process_audio" method="POST" style="display:none;">
            <input type="hidden" name="media_path" value="{{ media_path }}">
            <input type="hidden" name="context" value="{{ context }}">
        </form>
    </div>
    <form id="processForm" action="/process_audio" method="POST" style="display:none;">
        <input type="hidden" name="media_path" value="{{ media_path }}">
        <input type="hidden" name="context" value="{{ context or '' }}">
    </form>
    
    <script>
        const statusContainer = document.getElementById('statusContainer');
        const progressBar = document.getElementById('progressBarInner');
        const viewResultsBtn = document.getElementById('viewResultsBtn');
        const processForm = document.getElementById('processForm');

        const statuses = [
            document.getElementById('uploadStatus'),
            document.getElementById('analysisStatus'),
            document.getElementById('processingStatus'),
            document.getElementById('completedStatus')
        ];

        function updateStatus(currentIndex, message) {
            // Reset all statuses
            statuses.forEach((status, index) => {
                if (index <= currentIndex) {
                    status.classList.add('active');
                } else {
                    status.classList.remove('active');
                }
            });

            // Update progress bar
            progressBar.style.width = `${(currentIndex + 1) * 25}%`;
        }

        // Start processing immediately
        
        function startProcessing() {
            // Get media path and context from hidden form inputs
            const mediaPath = document.querySelector('input[name="media_path"]').value;
            const context = document.querySelector('input[name="context"]').value;

            // Log values for debugging
            console.log('Media Path:', mediaPath);
            console.log('Context:', context);

            // Construct URL with query parameters
            const url = `/process_audio?media_path=${encodeURIComponent(mediaPath)}&context=${encodeURIComponent(context)}`;

            // Create EventSource with the constructed URL
            const eventSource = new EventSource(url);

            let currentStatusIndex = 0;

            eventSource.addEventListener('status', function(event) {
                console.log('Status:', event.data);
                updateStatus(currentStatusIndex, event.data);
                currentStatusIndex = Math.min(currentStatusIndex + 1, 3);
            });

            eventSource.addEventListener('progress', function(event) {
                console.log('Progress:', event.data);
                progressBar.style.width = `${event.data}%`;
            });

            eventSource.addEventListener('result', function(event) {
                try {
                    const result = JSON.parse(event.data);
                    localStorage.setItem('analysisResult', JSON.stringify(result));
                    
                    viewResultsBtn.disabled = false;
                    viewResultsBtn.classList.remove('bg-gray-300');
                    viewResultsBtn.classList.add('bg-indigo-600');
                    viewResultsBtn.textContent = 'View Results';
                    viewResultsBtn.onclick = () => {
                        window.location.href = '/results';
                    };
                } catch (error) {
                    console.error('Error parsing result:', error);
                }
                eventSource.close();
            });

            eventSource.addEventListener('error', function(event) {
                console.error('Processing error:', event.data);
                eventSource.close();
            });
        }

        // Start processing when page loads
        window.onload = startProcessing;
        </script>        